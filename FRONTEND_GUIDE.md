# Frontend Integration Guide: Payment Link

Since your frontend is in a separate repository, you need to implement a new page (`/pay`) to handle the payment links generated by the backend.

## 1. Overview

**Goal**: Create a page accessible at `https://payment.vouchergalaxy.com/pay?token=...` that:
1.  Validates the provided `token` with the backend API.
2.  Retrieves the `client_secret` and amount details.
3.  Raenders the Stripe Payment Element for secure checkout.
4.  Completes the payment transaction.

---

## 2. API Integration Requirements

Your frontend will need to interact with these endpoint on your Backend (`https://api.vouchergalaxy.com`):

1.  **Validate Token**: `POST /payments/validate-token`
    *   **Body**: `{"token": "..."}`
    *   **Response**: `{"client_secret": "...", "publishable_key": "...", "amount": 100, "currency": "USD"}`
    *   **Purpose**: Get the secrets needed to initialize Stripe Elements.

2.  **Mark Token Used (Optional)**: `POST /payments/mark-token-used`
    *   **Body**: `{"token": "..."}`
    *   **Purpose**: Prevent the token from being reused if the user navigates back (though backend handles expiration).

---

## 3. Implementation Steps (React / Next.js)

### A. Install Dependencies
Ensure you have the Stripe React libraries installed in your frontend repo:
```bash
npm install @stripe/stripe-js @stripe/react-stripe-js
```

### B. Create the Payment Page (`/pay`)

This page logic handles the initialization.

**File:** `pages/pay.tsx` (or `app/pay/page.tsx` for App Router)

```tsx
import { useEffect, useState } from 'react';
import { loadStripe } from '@stripe/stripe-js';
import { Elements } from '@stripe/react-stripe-js';
import CheckoutForm from '../components/CheckoutForm'; // See Step C
import { useSearchParams } from 'next/navigation'; // or 'next/router'

export default function PaymentPage() {
  const [stripePromise, setStripePromise] = useState(null);
  const [clientSecret, setClientSecret] = useState("");
  const [amount, setAmount] = useState(0);
  const [currency, setCurrency] = useState("");
  const [returnUrl, setReturnUrl] = useState(""); // Store the return URL from backend
  
  // Get token from URL query params
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  useEffect(() => {
    if (!token) return;

    // 1. Call Backend to Validate Token
    fetch('https://api.vouchergalaxy.com/payments/validate-token', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.client_secret) {
          // 2. Initialize Stripe with the key from backend
          setStripePromise(loadStripe(data.publishable_key));
          setClientSecret(data.client_secret);
          setAmount(data.amount);
          setCurrency(data.currency);
          setReturnUrl(data.return_url); // <--- Important: Get the return URL
        } else {
          console.error("Invalid token or API error", data);
          // Handle error (e.g. redirect to error page)
        }
      })
      .catch(err => console.error("Network error", err));
  }, [token]);

  if (!clientSecret || !stripePromise) return <div>Loading Payment...</div>;

  // 3. Render Stripe Elements Provider
  return (
    <div className="payment-container max-w-md mx-auto p-6">
      <h1 className="text-2xl font-bold mb-4">Complete your Payment</h1>
      <p className="mb-6">Total: {(amount / 100).toFixed(2)} {currency.toUpperCase()}</p>
      
      <Elements stripe={stripePromise} options={{ clientSecret }}>
        <CheckoutForm token={token!} />
      </Elements>
    </div>
  );
}
```

### C. Create the Checkout Form Component

This component handles the actual payment submission.

**File:** `components/CheckoutForm.tsx`

```tsx
import { useState } from 'react';
import { useStripe, useElements, PaymentElement } from '@stripe/react-stripe-js';

export default function CheckoutForm({ token }: { token: string }) {
  const stripe = useStripe();
  const elements = useElements();
  const [message, setMessage] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) return;

    setIsLoading(true);

    // 4. Confirm Payment with Stripe
    constresult = await stripe.confirmPayment({
      elements,
      confirmParams: {
        // Where to redirect after success
        return_url: `${window.location.origin}/payment-success`, 
      },
      redirect: 'if_required' 
    });
    
    const { error, paymentIntent } = result;

    if (error) {
      setMessage(error.message ?? "An unexpected error occurred.");
    } else if (paymentIntent && paymentIntent.status === "succeeded") {
      // 5. Success! Mark token as used (optional)
      await fetch('https://api.vouchergalaxy.com/payments/mark-token-used', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token }),
      });
      
      // 6. REDIRECT USER
      // If the backend provided a return_url, go there. Otherwise fallback.
      // The return_url comes from the validate-token response (you need to store it in state)
      if (returnUrl) {
          window.location.href = returnUrl;
      } else {
          window.location.href = `/payment-success?order_id=${paymentIntent.metadata.order_id}`;
      }
    }

    setIsLoading(false);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <PaymentElement />
      <button 
        disabled={isLoading || !stripe || !elements} 
        id="submit"
        className="w-full bg-blue-600 text-white py-2 rounded disabled:opacity-50"
      >
        <span id="button-text">
          {isLoading ? "Processing..." : "Pay Now"}
        </span>
      </button>
      {message && <div id="payment-message" className="text-red-500">{message}</div>}
    </form>
  );
}
```

## 4. Summary

You need to add these files to your **Frontend Repository**:
1.  **Dependencies**: `@stripe/stripe-js`, `@stripe/react-stripe-js`
2.  **Pages**: `/pay` (Logic), `/payment-success` (Landing page)
3.  **Components**: `CheckoutForm` (UI)

This setup will seamlessly handle the traffic from your generated payment links.
